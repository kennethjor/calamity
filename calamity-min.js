/*! Calamity 0.5.0-rc.7 - MIT license */
(function(){"undefined"==typeof _&&"function"==typeof require&&(_=require("underscore"));var t={version:"0.5.0-rc.7"},r=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=t),exports.Calamity=t):"function"==typeof define&&define.amd?define(["calamity"],t):r.calamity=t;var i,s,e,n,o,u,a,h,p,c,d;i=t.Bus=function(){function t(){this.id=d.genId(),this._subscriptions={},this._bridges=[]}return t.prototype.subscribe=function(t,r,i){var s;return this._subscriptions[t]||(this._subscriptions[t]=[]),s=new u(t,r,i,this),this._subscriptions[t].push(s),this._bridgeProp("subscribe",{subscription:s}),s},t.prototype.unsubscribe=function(t,r){var i,s,e,n,o,a,h,p,c;if(e=t,e instanceof u){if(t=e.address,!this._subscriptions[t])return;for(p=this._subscriptions[t],i=n=0,a=p.length;a>n;i=++n)s=p[i],s===e&&this._subscriptions[t].splice(i)}else{if(!this._subscriptions[t])return;for(c=this._subscriptions[t],i=o=0,h=c.length;h>o;i=++o)s=c[i],s.address===t&&s.handler===r&&(e=s,this._subscriptions[t].splice(i))}this._bridgeProp("unsubscribe",{subscription:e})},t.prototype.publish=function(t,r,i){var s;return s=this._createMessage(t,r,i),t=s.address,s.sawBus(this)?this:(s.addBus(this),this._publishAddress(t,s),this._publishAddress("*",s),this._bridgeProp("publish",{message:s}),this)},t.prototype.send=function(t,r,i){var s;return s=this._createMessage(t,r,i),t=s.address,s.sawBus(this)?this:(s.addBus(this),this._sendAddress(t,s),this._bridgeProp("send",{message:s}),this)},t.prototype.bridge=function(t){if(!(t instanceof EventBridge))throw new Error("Briges must extend Calamity.EventBridge");return _.contains(this._bridges,t)||this._bridges.push(t),this},t.prototype._createMessage=function(t,r,i){var s;return s=t,s instanceof o||(s=new o(t,r,i)),s},t.prototype._publishAddress=function(t,r){var i,s,e,n;if(this._subscriptions[t])for(n=this._subscriptions[t],s=0,e=n.length;e>s;s++)i=n[s],i.trigger(r)},t.prototype._sendAddress=function(t,r){var i,s,e;this._subscriptions[t]&&(e=this._subscriptions[t],s=e.length,i=Math.floor(Math.random()*s),e[i].trigger(r))},t.prototype._bridgeProp=function(t,r){var i,s,e,n,o;if(this._bridges.length>0)for(i="bus."+t,r.bus=this,o=this._bridges,e=0,n=o.length;n>e;e++)s=o[e],s.trigger(i,r)},t}(),e=null,t.global=function(){return e||(e=new i),e},s=t.Emitter=function(){function t(){}return t.prototype.on=function(t,r,i){return i||(i=this),h(this).subscribe(t,r,i)},t.prototype.off=function(t,r,i){return p(this)?(i||(i=this),h(this).unsubscribe(t,r,i)):void 0},t.prototype.trigger=function(t,r,i){return p(this)?h(this).publish(t,r,i):void 0},t}(),p=function(t){var r,i;return null==(null!=t&&null!=(r=t._calamity)&&null!=(i=r.emitter)?i.bus:void 0)?!1:!0},h=function(t){var r,s;return r=t._calamity||(t._calamity={}),s=r.emitter||(r.emitter={}),s.bus||(s.bus=new i)},t.emitter=function(t){return _.extend(t,s.prototype)},o=t.Message=function(){function r(t,r,i){if(this.address=t,this.data=null!=r?r:{},this.id=d.genId(),this._busses=[],!_.isUndefined(i)&&!_.isFunction(i))throw new Error("Reply must be a function");this._replyHandler=i,this.status="ok",this.error=null}return r.prototype.reply=function(t,i){var s;return s=this._replyHandler,_.isFunction(s)?(t instanceof r||(t=new r(null,t,i)),s(t),this):void 0},r.prototype.replyError=function(t,i){var s,e,n,o,u,a;if(null==i&&(i={}),t instanceof Error){for(a="message,name,stack,fileName,lineNumber,description,number".split(","),o=0,u=a.length;u>o;o++)e=a[o],n=t[e],n&&"function"==typeof n.toString&&(n=n.toString()),i[e]=n;"function"==typeof t.toString&&(i.string=t.toString(),t=i.string,i.stack&&(t+=" :: "+i.stack))}return s=new r(null,i),s.status="error",s.error=t,this.reply(s),this},r.prototype["catch"]=function(t,i){var s;if(null==i){if(!_.isFunction(t))throw new Error("Supplied handler is not a function, "+typeof t+" supplied");i=t,t=void 0}if(_.isFunction(this._replyHandler)){if(null!=t){if(!(t instanceof r))return t instanceof Error||(t=new Error(t)),void this.replyError(t);if(t.isError())return void this.reply(t)}try{i(t)}catch(e){s=e,this.replyError(s)}}else{if(null!=t){if(!(t instanceof r))throw t instanceof Error||(t=new Error(t)),t;if(t.isError())throw t.error}i(t)}},r.prototype.isSuccess=function(){return"ok"===this.status},r.prototype.isError=function(){return"error"===this.status},r.prototype.getOptional=function(t,r){var i,s,e,n,o,u;if(s=t.split("."),e=this.data[s[0]],s.length>1)for(u=s.splice(1),n=0,o=u.length;o>n;n++){if(i=u[n],!_.isObject(e)||null==e[i]){e=void 0;break}e=e[i]}return"undefined"==typeof e?r:e},r.prototype.getRequired=function(t){var r;if(r=this.getOptional(t),"undefined"==typeof r)throw new Error('Variable "'+t+'" not found on message with address "'+this.address+'"');return r},r.prototype.addBus=function(t){return this.sawBus(t)?this:(this._busses.push(t.id),this)},r.prototype.sawBus=function(t){return _.contains(this._busses,t.id)},r.prototype.toJSON=function(){var r;return r={calamity:t.version,address:this.address,data:this.data,status:this.status,error:this.error},null!=this._replyHandler&&(r.reply=_.bind(this.reply,this)),r},r.fromJSON=function(t){var i;if(!_.isObject(t))throw new Error("JSON must be an object");if(null==t.calamity)throw new Error("Serialized JSON is not for calamity: "+JSON.stringify(t));return i=new r(t.address,t.data,t.reply),i.status=t.status,i.error=t.error,i},r}(),u=t.Subscription=function(){function t(t,r,i,s){this.address=t,this.handler=r,this.context=i,this.bus=s,this.id=d.genId(),this.active=!0}return t.prototype.unsubscribe=function(){return this.active?(this.bus.unsubscribe(this),this.active=!1,this):void 0},t.prototype.trigger=function(t){var r;return this.active?(r=_.bind(this.handler,this.context),r(t),this):this},t}(),c=Math.random,a=Math.floor,n="0123456789abcdef".split(""),d=t.util={genId:function(){var t,r,i;for(r="",t=i=1;32>=i;t=++i)r+=n[a(c()*n.length)];return r}}}).call(this);