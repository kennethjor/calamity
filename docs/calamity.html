<!DOCTYPE html>  <html> <head>   <title>calamity.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               calamity.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h1>EmitterMixin</h1>

<p>Mixin class for attaching an instance-local EventBus to objects.
It adds the <code>on()</code>, <code>off()</code>, and <code>_trigger()</code> methods to the object.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">EmitterMixin = </span><span class="k">class</span> <span class="nx">C</span><span class="p">.</span><span class="nx">EmitterMixin</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2><code>on()</code></h2>

<p>Register a handler to an address.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kc">on</span><span class="o">:</span> <span class="nf">(address, handler, context) -&gt;</span>
    <span class="nx">context</span> <span class="o">or=</span> <span class="nx">@</span>
    <span class="k">return</span> <span class="nx">getEmitterBus</span><span class="p">(</span><span class="nx">@</span><span class="p">).</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">address</span><span class="p">,</span> <span class="nx">handler</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h2><code>off()</code></h2>

<p>Unregisters a handler from an address.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kc">off</span><span class="o">:</span> <span class="nf">(address, handler, context) -&gt;</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">hasEmitterBus</span><span class="p">(</span><span class="nx">@</span><span class="p">)</span>
    <span class="nx">context</span> <span class="o">or=</span> <span class="nx">@</span>
    <span class="k">return</span> <span class="nx">getEmitterBus</span><span class="p">(</span><span class="nx">@</span><span class="p">).</span><span class="nx">unsubscribe</span><span class="p">(</span><span class="nx">address</span><span class="p">,</span> <span class="nx">handler</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h2><code>_trigger()</code></h2>

<p>Publishes an event to an address.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">trigger: </span><span class="nf">(address, data, reply) -&gt;</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">hasEmitterBus</span><span class="p">(</span><span class="nx">@</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">getEmitterBus</span><span class="p">(</span><span class="nx">@</span><span class="p">).</span><span class="nx">publish</span><span class="p">(</span><span class="nx">address</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Private statis function for checking is the object has an emitter bus.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">hasEmitterBus = </span><span class="nf">(obj) -&gt;</span>
  <span class="k">return</span> <span class="kc">false</span> <span class="nx">unless</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">_calamity</span>
  <span class="k">return</span> <span class="kc">false</span> <span class="nx">unless</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">_calamity</span><span class="p">.</span><span class="nx">emitter</span>
  <span class="k">return</span> <span class="kc">false</span> <span class="nx">unless</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">_calamity</span><span class="p">.</span><span class="nx">emitter</span><span class="p">.</span><span class="nx">bus</span>
  <span class="k">return</span> <span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Private static function for preparing an on-demand event bus for an object.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">getEmitterBus = </span><span class="nf">(obj) -&gt;</span>
  <span class="nv">calamity = </span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">_calamity</span> <span class="o">or=</span> <span class="p">{})</span>
  <span class="nv">emitter = </span><span class="p">(</span><span class="nx">calamity</span><span class="p">.</span><span class="nx">emitter</span> <span class="o">or=</span> <span class="p">{})</span>
  <span class="k">return</span> <span class="nx">emitter</span><span class="p">.</span><span class="nx">bus</span> <span class="o">or=</span> <span class="k">new</span> <span class="nx">EventBus</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h2><code>Calamity.emitter()</code></h2>

<p>Adds emitter functionality.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">C.emitter = </span><span class="nf">(obj) -&gt;</span>
  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">EmitterMixin</span><span class="p">.</span><span class="nx">prototype</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <h1>EventBridge</h1>

<p>Bridge for transfering events between two <code>EventBus</code> instances.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">EventBridge = </span><span class="k">class</span> <span class="nx">C</span><span class="p">.</span><span class="nx">EventBridge</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Constructor.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="nf">() -&gt;</span>
    <span class="vi">@_busses = </span><span class="p">[]</span>
    <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h2><code>connect()</code></h2>

<p>Connects this bridge to an event bus.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">connect: </span><span class="nf">(bus) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Add to internal list.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@_busses</span><span class="p">.</span><span class="nx">push</span> <span class="nx">bus</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Register handler on bus.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">bus</span><span class="p">.</span><span class="nx">subscribe</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">@handler</span><span class="p">,</span> <span class="nx">@</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">@</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <h2><code>handler()</code></h2>

<p>Default noop handler.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">handler: </span><span class="nf">(msg) -&gt;</span>
    <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <h1>EventBus</h1>

<p>Manages passing events from publishers to subscribers.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">EventBus = </span><span class="k">class</span> <span class="nx">C</span><span class="p">.</span><span class="nx">EventBus</span>
  <span class="nv">constructor: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Generate ID.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@id = </span><span class="nx">util</span><span class="p">.</span><span class="nx">genId</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Registered subscriptions container.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@_subscriptions = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <h2><code>subscribe()</code></h2>

<p>Register a handler to an address.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">subscribe: </span><span class="nf">(address, handler, context) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Initialize subscriptions container for this address.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">unless</span> <span class="nx">@_subscriptions</span><span class="p">[</span><span class="nx">address</span><span class="p">]</span>
      <span class="nx">@_subscriptions</span><span class="p">[</span><span class="nx">address</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Create subscription.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">sub = </span><span class="k">new</span> <span class="nx">Subscription</span> <span class="nx">address</span><span class="p">,</span> <span class="nx">handler</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">@</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Add to list.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@_subscriptions</span><span class="p">[</span><span class="nx">address</span><span class="p">].</span><span class="nx">push</span> <span class="nx">sub</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Return subscription.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="nx">sub</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <h2><code>unsubscribe()</code></h2>

<p>Unsubscribes a handler.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">unsubscribe: </span><span class="nf">(address, handler) -&gt;</span>
    <span class="nv">sub = </span><span class="nx">address</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Search by subscription.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">sub</span> <span class="k">instanceof</span> <span class="nx">Subscription</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Check address.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">address = </span><span class="nx">sub</span><span class="p">.</span><span class="nx">address</span>
      <span class="k">return</span> <span class="nx">unless</span> <span class="nx">@_subscriptions</span><span class="p">[</span><span class="nx">address</span><span class="p">]</span>
      <span class="k">for</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">@_subscriptions</span><span class="p">[</span><span class="nx">address</span><span class="p">]</span>
        <span class="k">if</span> <span class="nx">s</span> <span class="o">is</span> <span class="nx">sub</span>
          <span class="nx">@_subscriptions</span><span class="p">[</span><span class="nx">address</span><span class="p">].</span><span class="nx">splice</span> <span class="nx">i</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Otherwise search by address and handler.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Check for address.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="nx">unless</span> <span class="nx">@_subscriptions</span><span class="p">[</span><span class="nx">address</span><span class="p">]</span>
      <span class="k">for</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">@_subscriptions</span><span class="p">[</span><span class="nx">address</span><span class="p">]</span>
        <span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">address</span> <span class="o">is</span> <span class="nx">address</span> <span class="o">and</span> <span class="nx">s</span><span class="p">.</span><span class="nx">handler</span> <span class="o">is</span> <span class="nx">handler</span>
          <span class="nx">@_subscriptions</span><span class="p">[</span><span class="nx">address</span><span class="p">].</span><span class="nx">splice</span> <span class="nx">i</span>
    <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <h2><code>publish()</code></h2>

<p>Publishes an event to an address.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">publish: </span><span class="nf">(address, data, reply) -&gt;</span>
    <span class="nv">msg = </span><span class="nx">@_createMessage</span> <span class="nx">address</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">reply</span>
    <span class="nv">address = </span><span class="nx">msg</span><span class="p">.</span><span class="nx">address</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Check if message has already been processed by this bus.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="nx">@</span> <span class="k">if</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sawBus</span> <span class="nx">@</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Register this bus on the event</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">msg</span><span class="p">.</span><span class="nx">addBus</span> <span class="nx">@</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Publish to target address.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@_publishAddress</span> <span class="nx">address</span><span class="p">,</span> <span class="nx">msg</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Publish to wildcard address.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@_publishAddress</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="nx">msg</span>

    <span class="k">return</span> <span class="nx">@</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Utility function for creating messages.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_createMessage: </span><span class="nf">(address, data, reply) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Construct new EventMessage is necesarry.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">msg = </span><span class="nx">address</span>
    <span class="nx">unless</span> <span class="nx">msg</span> <span class="k">instanceof</span> <span class="nx">EventMessage</span>
      <span class="nv">msg = </span><span class="k">new</span> <span class="nx">EventMessage</span> <span class="nx">address</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">reply</span>
    <span class="k">return</span> <span class="nx">msg</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Publishes a message to an address.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_publishAddress: </span><span class="nf">(address, msg) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Check if we have subscriptions at all for this address.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">@_subscriptions</span><span class="p">[</span><span class="nx">address</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Send message to all subscriptions.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">subscription</span> <span class="k">in</span> <span class="nx">@_subscriptions</span><span class="p">[</span><span class="nx">address</span><span class="p">]</span>
      <span class="nx">subscription</span><span class="p">.</span><span class="nx">trigger</span> <span class="nx">msg</span>
    <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <h1>EventMessage</h1>

<p>Represents a single message in the system.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">EventMessage = </span><span class="k">class</span> <span class="nx">C</span><span class="p">.</span><span class="nx">EventMessage</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Constructor.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="nf">(@address, @data, @_replyHandler) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Generate ID.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@id = </span><span class="nx">util</span><span class="p">.</span><span class="nx">genId</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Remebered busses container.
This will store the ID of every bus the event has seen, to prevent repeated execution.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@_busses = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Check reply handler.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">unless</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">@_replyHandler</span><span class="p">)</span> <span class="o">or</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">@_replyHandler</span><span class="p">)</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Reply must be a function&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <h2><code>reply()</code></h2>

<p>Executes the reply handler, if this message has one.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">reply: </span><span class="nf">(data) -&gt;</span>
    <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">@_replyHandler</span><span class="p">)</span>
      <span class="nv">replyHandler = </span><span class="nx">@_replyHandler</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">defer</span> <span class="o">-&gt;</span>
        <span class="nx">replyHandler</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">return</span> <span class="nx">@</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <h2><code>addBus()</code></h2>

<p>Adds a bus to the internal list.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">addBus: </span><span class="nf">(bus) -&gt;</span>
    <span class="k">return</span> <span class="nx">@</span> <span class="k">if</span> <span class="nx">@sawBus</span><span class="p">(</span><span class="nx">bus</span><span class="p">)</span>
    <span class="nx">@_busses</span><span class="p">.</span><span class="nx">push</span> <span class="nx">bus</span><span class="p">.</span><span class="nx">id</span>
    <span class="k">return</span> <span class="nx">@</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <h2><code>sawBus()</code></h2>

<p>Returns true if this message has been processed by the supplied bus.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">sawBus: </span><span class="nf">(bus) -&gt;</span>
    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">contains</span> <span class="nx">@_busses</span><span class="p">,</span> <span class="nx">bus</span><span class="p">.</span><span class="nx">id</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <h2><code>serialize()</code></h2>

<p>Serializes the message as JSON.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">serialize: </span><span class="o">-&gt;</span>
    <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span> <span class="nx">@</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <h2><code>deserialize()</code></h2>

<p>Desrialises a message from JSON.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">EventMessage.deserialize = </span><span class="nf">(json) -&gt;</span>
  <span class="k">return</span> <span class="kc">undefined</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <h1>MemoryEventBridge</h1>

<p><code>EventBridge</code> implementation which ties to <code>EventBus</code> instances together directly in memory.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">MemoryEventBridge = </span><span class="k">class</span> <span class="nx">C</span><span class="p">.</span><span class="nx">MemoryEventBridge</span> <span class="k">extends</span> <span class="nx">EventBridge</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <h2><code>handler()</code></h2>

<p>Repeating handler implementation.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">handler: </span><span class="nf">(msg) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <pre><code>console.log msg.serialize() + "\n\n"
</code></pre>

<p>Pass msg onto all connected busses</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">bus</span> <span class="k">in</span> <span class="nx">@_busses</span>
      <span class="nx">bus</span><span class="p">.</span><span class="nx">publish</span> <span class="nx">msg</span>
    <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <h1>ProxyMixin</h1>

<p>Mixin class for attaching global <code>EventBus</code> handling to objects.
It adds the <code>_subscribe()</code> and <code>_publish()</code> methods to the class, which automatically sets the context of any handler
to <code>this</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">ProxyMixin = </span><span class="k">class</span> <span class="nx">C</span><span class="p">.</span><span class="nx">ProxyMixin</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <h2><code>_subscribe()</code></h2>

<p>Register a handler to an address with.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">subscribe: </span><span class="nf">(address, handler) -&gt;</span>
    <span class="k">return</span> <span class="nx">@_calamity</span><span class="p">.</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">bus</span><span class="p">.</span><span class="nx">subscribe</span> <span class="nx">address</span><span class="p">,</span> <span class="nx">handler</span><span class="p">,</span> <span class="nx">@</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <h2><code>_publish()</code></h2>

<p>Publishes an event to an address.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">publish: </span><span class="nf">(address, data, reply) -&gt;</span>
    <span class="k">return</span> <span class="nx">@_calamity</span><span class="p">.</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">bus</span><span class="p">.</span><span class="nx">publish</span> <span class="nx">address</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">reply</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>We automatically construct a default global bus when needed.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">PROXY_GLOBAL_BUS = </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <h2><code>Calamity.proxy()</code></h2>

<p>Adds proxy functionality.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">C.proxy = </span><span class="nf">(obj, bus) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Prepare bus.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">unless</span> <span class="nx">bus</span> <span class="k">instanceof</span> <span class="nx">EventBus</span>
    <span class="nx">PROXY_GLOBAL_BUS</span> <span class="o">or=</span> <span class="k">new</span> <span class="nx">EventBus</span><span class="p">()</span>
    <span class="nv">bus = </span><span class="nx">PROXY_GLOBAL_BUS</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>Attach bus.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">c = </span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">_calamity</span> <span class="o">or=</span> <span class="p">{})</span>
  <span class="nv">c.proxy =</span>
    <span class="nv">bus: </span><span class="nx">bus</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>Extend.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">ProxyMixin</span><span class="p">.</span><span class="nx">prototype</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <h1>Subscription</h1>

<p>Represents a subscription of a handler to an address on an bus.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Subscription = </span><span class="k">class</span> <span class="nx">C</span><span class="p">.</span><span class="nx">Subscription</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>Constructor.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="nf">(@address, @handler, @context, @bus) -&gt;</span>
    <span class="vi">@id = </span><span class="nx">util</span><span class="p">.</span><span class="nx">genId</span><span class="p">()</span>
    <span class="vi">@active = </span><span class="kc">true</span>
    <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <h2><code>unsubscribe()</code></h2>

<p>Shorthand for unsubscribing.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">unsubscribe: </span><span class="o">-&gt;</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">@_active</span>
    <span class="nx">@bus</span><span class="p">.</span><span class="nx">unsubscribe</span> <span class="nx">@</span>
    <span class="vi">@active = </span><span class="kc">false</span>
    <span class="k">return</span> <span class="nx">@</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <h2><code>trigger()</code></h2>

<p>Fires the handler with the supplied message.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">trigger: </span><span class="nf">(msg) -&gt;</span>
    <span class="k">return</span> <span class="nx">@</span> <span class="nx">unless</span> <span class="nx">@active</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Bind handler.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">bound = </span><span class="nx">_</span><span class="p">.</span><span class="nx">bind</span> <span class="nx">@handler</span><span class="p">,</span> <span class="nx">@context</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>Execute.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">_</span><span class="p">.</span><span class="nx">defer</span> <span class="o">-&gt;</span>
      <span class="nx">bound</span> <span class="nx">msg</span>
      <span class="k">return</span>

    <span class="k">return</span> <span class="nx">@</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <h1>util</h1>

<p>A set of utilities used inside Calamity.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>Import Math functions.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">random = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span>
<span class="nv">floor = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>Hexadecimals.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">HEX = </span><span class="s">&quot;0123456789abcdef&quot;</span><span class="p">.</span><span class="nx">split</span> <span class="s">&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>Generic utility functions.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">util = C.util =</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>Generates a 128 bit ID.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">genId: </span><span class="o">-&gt;</span>
    <span class="nv">id = </span><span class="s">&quot;&quot;</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">..</span><span class="mi">32</span><span class="p">]</span>
      <span class="nx">id</span> <span class="o">+=</span> <span class="nx">HEX</span><span class="p">[</span><span class="nx">floor</span><span class="p">(</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">HEX</span><span class="p">.</span><span class="nx">length</span><span class="p">)]</span>
    <span class="k">return</span> <span class="nx">id</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 